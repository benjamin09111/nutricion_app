generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                 String           @id @default(uuid())
  email              String           @unique
  password           String?
  role               UserRole         @default(NUTRITIONIST)
  status             AccountStatus    @default(ACTIVE)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  plan               SubscriptionPlan @default(FREE)
  subscriptionEndsAt DateTime?        @map("subscription_ends_at")
  nutritionist       Nutritionist?
  payments           Payment[]
  subscription       Subscription?

  @@map("accounts")
}

model Nutritionist {
  id                    String                 @id @default(uuid())
  accountId             String                 @unique
  fullName              String                 @map("full_name")
  professionalId        String?                @map("professional_id")
  specialty             String?
  phone                 String?
  avatarUrl             String?                @map("avatar_url")
  settings              Json?                  @default("{}")
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  ingredientGroups      IngredientGroup[]
  ingredientPreferences IngredientPreference[]
  customIngredients     Ingredient[]
  account               Account                @relation(fields: [accountId], references: [id], onDelete: Cascade)
  patients              Patient[]
  recipes               Recipe[]

  @@map("nutritionists")
}

model Patient {
  id             String       @id @default(uuid())
  nutritionistId String       @map("nutritionist_id")
  fullName       String       @map("full_name")
  email          String?
  phone          String?
  documentId     String?      @map("document_id")
  birthDate      DateTime?    @map("birth_date")
  gender         String?
  height         Float?
  weight         Float?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  nutritionist   Nutritionist @relation(fields: [nutritionistId], references: [id])

  @@map("patients")
}

model Ingredient {
  id                String                 @id @default(uuid())
  name              String
  price             Int                    @default(0)
  unit              String
  amount            Float                  @default(100)
  calories          Float
  proteins          Float
  lipids            Float                  @default(0)
  carbs             Float
  sugars            Float?                 @default(0)
  fiber             Float?                 @default(0)
  sodium            Float?                 @default(0)
  ingredients       String?
  isPublic          Boolean                @default(false) @map("is_public")
  verified          Boolean                @default(false)
  nutritionistId    String?                @map("nutritionist_id")
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  brandId           String?                @map("brand_id")
  categoryId        String                 @map("category_id")
  groupEntries      IngredientGroupEntry[]
  preferences       IngredientPreference[]
  brand             IngredientBrand?       @relation(fields: [brandId], references: [id])
  category          IngredientCategory     @relation(fields: [categoryId], references: [id])
  nutritionist      Nutritionist?          @relation(fields: [nutritionistId], references: [id])
  recipeIngredients RecipeIngredient[]
  tags              Tag[]                  @relation("GlobalTags")

  @@index([name])
  @@index([isPublic, verified])
  @@map("ingredients")
}

model IngredientBrand {
  id          String       @id @default(uuid())
  name        String       @unique
  ingredients Ingredient[]

  @@map("ingredient_brands")
}

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String       @unique
  ingredients Ingredient[]

  @@map("ingredient_categories")
}

model Tag {
  id               String                 @id @default(uuid())
  name             String                 @unique
  ingredients      Ingredient[]           @relation("GlobalTags")
  ingredientGroups IngredientGroup[]      @relation("GroupTags")
  preferences      IngredientPreference[] @relation("PersonalTags")

  @@map("tags")
}

model IngredientPreference {
  id               String       @id @default(uuid())
  nutritionistId   String       @map("nutritionist_id")
  ingredientId     String       @map("ingredient_id")
  isFavorite       Boolean      @default(false) @map("is_favorite")
  isNotRecommended Boolean      @default(false) @map("is_not_recommended")
  isHidden         Boolean      @default(false) @map("is_hidden")
  ingredient       Ingredient   @relation(fields: [ingredientId], references: [id])
  nutritionist     Nutritionist @relation(fields: [nutritionistId], references: [id])
  tags             Tag[]        @relation("PersonalTags")

  @@unique([nutritionistId, ingredientId])
  @@map("ingredient_preferences")
}

model IngredientGroup {
  id             String                 @id @default(uuid())
  name           String
  nutritionistId String                 @map("nutritionist_id")
  description    String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  entries        IngredientGroupEntry[]
  nutritionist   Nutritionist           @relation(fields: [nutritionistId], references: [id], onDelete: Cascade)
  tags           Tag[]                  @relation("GroupTags")

  @@map("ingredient_groups")
}

model IngredientGroupEntry {
  id              String          @id @default(uuid())
  groupId         String          @map("group_id")
  ingredientId    String          @map("ingredient_id")
  brandSuggestion String?         @map("brand_suggestion")
  amount          Float?          @default(1)
  unit            String?
  group           IngredientGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  ingredient      Ingredient      @relation(fields: [ingredientId], references: [id])

  @@index([groupId])
  @@index([ingredientId])
  @@map("ingredient_group_entries")
}

model FoodPriceRecord {
  id                 String   @id @default(uuid())
  anio               String
  mes                String
  semana             String
  fechaInicio        String   @map("fecha_inicio")
  fechaTermino       String   @map("fecha_termino")
  idRegion           String   @map("id_region")
  region             String
  sector             String
  tipoPuntoMonitoreo String   @map("tipo_punto_monitoreo")
  grupo              String
  producto           String
  unidad             String
  precioMin          Float    @map("precio_minimo")
  precioMax          Float    @map("precio_maximo")
  precioPromedio     Float    @map("precio_promedio")
  createdAt          DateTime @default(now())

  @@index([producto])
  @@index([region])
  @@index([grupo])
  @@map("food_price_records")
}

model SupportRequest {
  id        String               @id @default(uuid())
  email     String
  message   String?
  type      SupportRequestType
  status    SupportRequestStatus @default(PENDING)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@map("support_requests")
}

model RegistrationRequest {
  id             String        @id @default(uuid())
  fullName       String        @map("full_name")
  email          String
  phone          String?
  professionalId String?       @map("professional_id")
  specialty      String?
  message        String?
  status         RequestStatus @default(PENDING)
  adminNotes     String?       @map("admin_notes")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("registration_requests")
}

model MembershipPlan {
  id                    String              @id @default(uuid())
  name                  String
  slug                  String              @unique
  description           String?
  price                 Decimal             @db.Decimal(10, 2)
  currency              String              @default("CLP")
  billingPeriod         String              @default("monthly")
  features              Json
  maxPatients           Int?
  maxStorage            Int?
  isPopular             Boolean             @default(false)
  isActive              Boolean             @default(true)
  displayOrder          Int                 @default(0)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  newSubscriptionEvents SubscriptionEvent[] @relation("NewPlan")
  oldSubscriptionEvents SubscriptionEvent[] @relation("OldPlan")
  subscriptions         Subscription[]

  @@map("membership_plans")
}

model Payment {
  id                 String              @id @default(uuid())
  accountId          String              @map("account_id")
  amount             Decimal             @db.Decimal(10, 2)
  currency           String              @default("CLP")
  status             PaymentStatus       @default(PENDING)
  method             PaymentMethod
  transactionId      String?             @unique @map("transaction_id")
  idempotencyKey     String?             @unique @map("idempotency_key")
  metadata           Json?               @default("{}")
  paidAt             DateTime?           @map("paid_at")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  account            Account             @relation(fields: [accountId], references: [id])
  subscriptionEvents SubscriptionEvent[]

  @@map("payments")
}

model Subscription {
  id                String              @id @default(uuid())
  accountId         String              @unique @map("account_id")
  planId            String              @map("plan_id")
  status            SubscriptionStatus  @default(TRIALING)
  startDate         DateTime            @default(now()) @map("start_date")
  endDate           DateTime?           @map("end_date")
  cancelAtPeriodEnd Boolean             @default(false) @map("cancel_at_period_end")
  canceledAt        DateTime?           @map("canceled_at")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  events            SubscriptionEvent[]
  account           Account             @relation(fields: [accountId], references: [id])
  plan              MembershipPlan      @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model SubscriptionEvent {
  id             String          @id @default(uuid())
  subscriptionId String          @map("subscription_id")
  eventType      String          @map("event_type")
  paymentId      String?         @map("payment_id")
  oldPlanId      String?         @map("old_plan_id")
  newPlanId      String?         @map("new_plan_id")
  metadata       Json?           @default("{}")
  createdAt      DateTime        @default(now())
  newPlan        MembershipPlan? @relation("NewPlan", fields: [newPlanId], references: [id])
  oldPlan        MembershipPlan? @relation("OldPlan", fields: [oldPlanId], references: [id])
  payment        Payment?        @relation(fields: [paymentId], references: [id])
  subscription   Subscription    @relation(fields: [subscriptionId], references: [id])

  @@map("subscription_events")
}

model DailyMetric {
  id                  String   @id @default(uuid())
  date                DateTime @unique
  totalRevenue        Decimal  @default(0) @map("total_revenue") @db.Decimal(10, 2)
  revenueGrowth       Float    @default(0) @map("revenue_growth")
  totalUsers          Int      @default(0) @map("total_users")
  activeUsers         Int      @default(0) @map("active_users")
  newUsers            Int      @default(0) @map("new_users")
  activeSubscriptions Int      @default(0) @map("active_subscriptions")
  churnRate           Float    @default(0) @map("churn_rate")
  createdAt           DateTime @default(now())

  @@map("daily_metrics")
}

model Recipe {
  id             String             @id @default(uuid())
  name           String
  description    String?
  preparation    String?
  portionSize    Float              @default(100) @map("portion_size")
  portions       Int                @default(1)
  calories       Float              @default(0)
  proteins       Float              @default(0)
  carbs          Float              @default(0)
  lipids         Float              @default(0)
  fiber          Float?             @default(0)
  sodium         Float?             @default(0)
  isPublic       Boolean            @default(false) @map("is_public")
  nutritionistId String?            @map("nutritionist_id")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  ingredients    RecipeIngredient[]
  nutritionist   Nutritionist?      @relation(fields: [nutritionistId], references: [id])

  @@map("recipes")
}

model RecipeIngredient {
  id              String     @id @default(uuid())
  recipeId        String     @map("recipe_id")
  ingredientId    String     @map("ingredient_id")
  amount          Float
  unit            String
  brandSuggestion String?    @map("brand_suggestion")
  ingredient      Ingredient @relation(fields: [ingredientId], references: [id])
  recipe          Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipe_ingredients")
}

enum UserRole {
  ADMIN
  NUTRITIONIST
  ORGANIZATION
  SUPPLEMENT_STORE
  SUPERMARKET
  ADMIN_MASTER
  ADMIN_GENERAL
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SupportRequestType {
  PASSWORD_RESET
  CONTACT
  OTHER
  FEEDBACK
  COMPLAINT
  IDEA
}

enum SupportRequestStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  ACCEPTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  TRANSBANK
  WEBPAY
  MERCADOPAGO
  STRIPE
  BANK_TRANSFER
  MANUAL
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

model Announcement {
  id          String   @id @default(uuid())
  title       String
  message     String
  type        String   @default("info")
  link        String?
  targetRoles String[] // ['ALL'], ['ADMIN'], ['NUTRITIONIST']
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("announcements")
}
